name: reusable-sbom-policy

on:
  workflow_call:
    inputs:
      upload_sbom:
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write

jobs:
  sbom-and-policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Génère un SBOM repo-wide (polyglot) via Syft (très robuste)
      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom-repo.json

      - name: Upload SBOM
        if: inputs.upload_sbom
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom-repo.json

      - name: Checkout compliance repo
        uses: actions/checkout@v4
        with:
          repository: HaitamELF/org-oss-compliance
          path: compliance

      - name: Check forbidden licenses (SSPL/AGPL) + exceptions
        run: |
          python3 compliance/scripts/check_licenses.py
        env:
          DENYLIST_FILE: compliance/policy/licenses-denylist.txt
          EXCEPTIONS_FILE: .compliance/exceptions.json

      - name: Upload forbidden report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: forbidden-licenses
          path: forbidden-licenses.json